"""
Usage:
    spike_study.py <inputfile> [options]

Options:
    -n <cores>       Cores to use [default: 1]
    -v <verbosity>   Verbosity [default: 10]
    -m <max_events>  Maximum number of Events

apply TimelapseCalibration for given .dat file(s):
inputfile: .pickle file generated by apply_timelapse_calibration.py
"""

from joblib import Parallel, delayed
from docopt import docopt
import joblib

def calc_data(event, max_events):
    """Spike study"""
    for pixel in range(7):
        for channel in event.data.dtype.names:
            if any(event.data[pixel][channel]) > 20:
                return event


if __name__ == '__main__':
    args = docopt(
        __doc__, version='Dragon Board spike study software v.1.0'
    )

    calib_events = joblib.load(args['<inputfile>'])
    max_events = int(args['-m']) if args['-m'] else 1e20

    with Parallel(int(args['-n']), verbose=10) as pool:

        data = list(
            pool(
                delayed(calc_data)(event, max_events) for event in calib_events if event.header.event_counter <= max_events
            )
        )

    print(data)
